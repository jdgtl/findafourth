name: Intelligent Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_all_tests:
        description: 'Run all tests regardless of changes'
        required: false
        default: 'false'
        type: boolean

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_NA4 }}

jobs:
  analyze:
    name: Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      affected_features: ${{ steps.analyze.outputs.affected_features }}
      run_e2e: ${{ steps.analyze.outputs.run_e2e }}
      run_unit: ${{ steps.analyze.outputs.run_unit }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Analyze changed files
        id: analyze
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED=$(git diff --name-only HEAD~1)
          fi

          echo "Changed files:"
          echo "$CHANGED"

          # Determine what to run
          RUN_E2E="false"
          RUN_UNIT="false"
          FEATURES=""

          # Force all tests if manually triggered with force_all_tests
          if [ "${{ inputs.force_all_tests }}" == "true" ]; then
            RUN_E2E="true"
            RUN_UNIT="true"
          fi

          # Frontend source changes trigger both
          if echo "$CHANGED" | grep -qE "pages/|components/|contexts/"; then
            RUN_E2E="true"
            RUN_UNIT="true"
          fi

          # Test infrastructure changes trigger E2E
          if echo "$CHANGED" | grep -qE "e2e/|playwright|\.spec\."; then
            RUN_E2E="true"
          fi

          # Unit test changes trigger unit tests
          if echo "$CHANGED" | grep -qE "lib/|utils|__tests__|\.test\.|setupTests"; then
            RUN_UNIT="true"
          fi

          # Specific feature detection
          if echo "$CHANGED" | grep -qE "Login|Signup|Auth"; then
            FEATURES="${FEATURES}auth,"
          fi
          if echo "$CHANGED" | grep -qE "Profile|CompleteProfile|PTI"; then
            FEATURES="${FEATURES}profile,"
          fi
          if echo "$CHANGED" | grep -qE "Club"; then
            FEATURES="${FEATURES}clubs,"
          fi
          if echo "$CHANGED" | grep -qE "Request|Home"; then
            FEATURES="${FEATURES}requests,"
          fi

          echo "affected_features=${FEATURES}" >> $GITHUB_OUTPUT
          echo "run_e2e=${RUN_E2E}" >> $GITHUB_OUTPUT
          echo "run_unit=${RUN_UNIT}" >> $GITHUB_OUTPUT

  unit-tests:
    name: Unit Tests
    needs: analyze
    if: needs.analyze.outputs.run_unit == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: frontend/yarn.lock

      - name: Install dependencies
        working-directory: frontend
        run: yarn install --frozen-lockfile

      - name: Run unit tests
        working-directory: frontend
        run: yarn test --watchAll=false --coverage --ci
        env:
          CI: true

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: frontend/coverage/

  e2e-tests:
    name: E2E Tests (Shard ${{ matrix.shard }})
    needs: analyze
    if: needs.analyze.outputs.run_e2e == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: frontend/yarn.lock

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        working-directory: backend
        run: pip install -r requirements.txt

      - name: Start backend
        working-directory: backend
        run: |
          uvicorn server:app --host 0.0.0.0 --port 8000 &
          sleep 10
        env:
          MONGO_URL: mongodb://localhost:27017
          DB_NAME: needafourth_test
          JWT_SECRET: test-secret-key

      - name: Install frontend dependencies
        working-directory: frontend
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Build frontend
        working-directory: frontend
        run: yarn build
        env:
          REACT_APP_BACKEND_URL: http://localhost:8000
          CI: false  # Treat warnings as warnings, not errors

      - name: Serve frontend
        working-directory: frontend
        run: |
          npx serve -s build -l 3000 &
          sleep 5

      - name: Run E2E tests (shard ${{ matrix.shard }}/2)
        working-directory: frontend
        run: npx playwright test --project=chromium --shard=${{ matrix.shard }}/2 --reporter=html
        env:
          FRONTEND_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-shard-${{ matrix.shard }}
          path: frontend/playwright-report/
          retention-days: 30

  intelligent-agent:
    name: Claude Test Agent
    needs: [analyze]
    if: needs.analyze.outputs.run_e2e == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install agent dependencies
        run: pip install anthropic

      - name: Determine base ref
        id: base
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ref=origin/${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            echo "ref=HEAD~1" >> $GITHUB_OUTPUT
          fi

      - name: Run Intelligent Test Agent
        run: |
          python scripts/intelligent_test_agent.py \
            --base-ref ${{ steps.base.outputs.ref }} \
            --skip-e2e \
            --output test-agent-report.md
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_NA4 }}
        continue-on-error: true

      - name: Upload agent report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-agent-report
          path: test-agent-report.md

      - name: Comment on PR
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'test-agent-report.md';

            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              const truncated = report.length > 60000
                ? report.substring(0, 60000) + '\n\n... (truncated)'
                : report;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: truncated
              });
            }

  merge-reports:
    name: Merge E2E Reports
    needs: [e2e-tests]
    if: always() && needs.e2e-tests.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download shard reports
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-report-shard-*
          path: frontend/all-reports

      - name: Merge reports
        run: |
          npx playwright merge-reports --reporter html ./all-reports
        working-directory: frontend

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-merged
          path: frontend/playwright-report/
          retention-days: 30

  report:
    name: Test Summary
    needs: [unit-tests, e2e-tests, merge-reports]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.unit-tests.result }}" == "failure" ] || \
             [ "${{ needs.e2e-tests.result }}" == "failure" ]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed"
          fi
